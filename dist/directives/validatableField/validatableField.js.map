{"version":3,"sources":["directives/validatableField/validatableField.ts"],"names":[],"mappings":"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","file":"validatableField.js","sourcesContent":["import 'angular';\r\n\r\nimport { IValidationRule } from '../../interfaces/validationRule';\r\nimport { InitValidationModuleProvider } from '../../init/initValidationModuleProvider';\r\nimport { IValidatableController } from '../../controllers/validatableController';\r\nimport { ValidationUtilities } from '../../utils/validationUtilities';\r\nimport { ErrorProcessor } from '../../utils/errorProcessor';\r\nimport { ValidationCore } from '../../core/validationCore';\r\n\r\n/**\r\n * directive for validation purposes.\r\n * inits watch on the model and validates changes in the model automatically.\r\n */\r\nexport class ValidatableFieldDirective implements ng.IDirective {\r\n\r\n    public restrict: string = 'A';\r\n    public require: string = 'ngModel';\r\n    public scope: any = { validatableField: '=', validatableGroup: '@' };\r\n\r\n    /**\r\n     * creates a new instance of directive\r\n     */\r\n    public static factory(): ValidatableFieldDirective {\r\n        return new ValidatableFieldDirective();\r\n    }\r\n\r\n    /**\r\n     * link for directive.\r\n     *\r\n     * @param scope\r\n     * @param element\r\n     * @param attrs\r\n     * @param ctrl\r\n     */\r\n    public link(scope: any, element: ng.IAugmentedJQuery, attrs: ng.IAttributes): void {\r\n\r\n        let worker: DirectiveWorker = new DirectiveWorker();\r\n        let basicController: IValidatableController = ValidationUtilities.getController(scope.validatableField);\r\n        if (worker.initFields(scope, element, attrs, basicController, scope.validatableGroup)) {\r\n            worker.watchModel(scope);\r\n            worker.watchError(scope);\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * class for processing directive tasks.\r\n */\r\nclass DirectiveWorker {\r\n\r\n    private element: any;\r\n    private fieldName: string;\r\n    private seqRules: Array<Array<IValidationRule>>;\r\n    private form: ng.IFormController;\r\n    private item: any;\r\n\r\n    private timer: any = null;\r\n    private groupFields: Array<string> = new Array<string>();\r\n\r\n    /**\r\n     * inits the main fields needed to proper work of the directive.\r\n     *\r\n     * @param scope - scope\r\n     * @param element - input element\r\n     * @param attrs - element attributes.\r\n     * @param ctrl - controller.\r\n     * @param validatableGroup - the fields which should be validated as well on this item validation.\r\n     * @returns {boolean}\r\n     */\r\n    public initFields(\r\n        scope: ng.IScope,\r\n        element: ng.IAugmentedJQuery,\r\n        attrs: ng.IAttributes,\r\n        ctrl: IValidatableController,\r\n        validatableGroup: string\r\n    ): boolean {\r\n\r\n        this.element = element;    \r\n        this.fieldName = attrs['name'];\r\n        this.form = ctrl.form;\r\n        this.seqRules = ctrl.rulesCustomizer.seqRules(this.fieldName);\r\n        this.item = ctrl.item;\r\n        \r\n        if (validatableGroup) {\r\n            this.groupFields = validatableGroup.split(',');            \r\n        }\r\n\r\n        this.groupFields.push(this.fieldName);\r\n\r\n        if (this.seqRules && this.seqRules.length) {\r\n            return true;\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * makes a watch on the model value.\r\n     *\r\n     * @param scope - scope\r\n     * @param attr - element attributes\r\n     */\r\n    public watchModel(scope: ng.IScope): void {\r\n\r\n        scope.$watch(`validatableField.item.${this.fieldName}`,\r\n            (newVal: any, oldVal: any) => {\r\n\r\n                if (newVal !== oldVal) {\r\n\r\n                    for (let i = 0; i < this.groupFields.length; i++) { \r\n                        ErrorProcessor.clearFieldErrors(this.groupFields[i], this.form);\r\n                    }\r\n\r\n                    if (this.timer) {\r\n                        clearTimeout(this.timer);\r\n                    }\r\n\r\n                    this.timer = setTimeout(() => {                            \r\n\r\n                            ValidationCore.validateRules(this.item,\r\n                                this.seqRules,\r\n                                0,\r\n                                (rule: IValidationRule, result: boolean) => {\r\n\r\n                                    if (!result) {\r\n                                        scope.$apply(() => {\r\n\r\n                                            for (let i = 0; i < this.groupFields.length; i++) { \r\n                                                ErrorProcessor.setFieldError(this.groupFields[i], rule.attribute, this.form);\r\n                                            }\r\n                                            \r\n                                        });\r\n                                    }\r\n                                });\r\n                        },\r\n                        InitValidationModuleProvider.config.validationTimoutMs);\r\n                }\r\n            });\r\n    }\r\n\r\n    /**\r\n     * makes watch to apply error to field if needed.\r\n     * \r\n     * @param scope\r\n     */\r\n    public watchError(scope: ng.IScope): void {\r\n\r\n        scope.$watch(`validatableField.form.$error.${this.fieldName}`,\r\n            (newVal: any, oldVal: any) => {\r\n\r\n                if (newVal !== oldVal) {\r\n                    let isFieldValid = ErrorProcessor.isFieldValid(this.fieldName, this.form);\r\n                    InitValidationModuleProvider.config.fieldErrorHandler(!isFieldValid, this.element, this.fieldName);\r\n                }\r\n            });\r\n    }\r\n}\r\n"]}